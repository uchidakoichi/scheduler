<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamSync | å…±åŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --surface-hover: #334155;
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --grid-border: rgba(255, 255, 255, 0.1);
            --header-bg: rgba(15, 23, 42, 0.8);
            --modal-bg: rgba(0, 0, 0, 0.6);
            --input-bg: rgba(0, 0, 0, 0.2);

            /* Category Colors */
            --cat-zen: #3b82f6;
            /* Blue - å…¨ */
            --cat-sei: #10b981;
            /* Green - æ•´ */
            --cat-toku: #a855f7;
            /* Purple - ç‰¹ */
            --cat-cho: #f97316;
            /* Orange - èª¿ */
            --cat-tou: #ef4444;
            /* Red - å½“ */
            --cat-kyu: #64748b;
            /* Slate - ä¼‘ */
            --cat-private: #d8b4fe;
            /* Purple Stripe - ç§˜ */
        }

        :root.light-mode {
            --bg-color: #f1f5f9;
            --surface-color: #ffffff;
            --surface-hover: #e2e8f0;
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #cbd5e1;
            --grid-border: rgba(0, 0, 0, 0.1);
            --header-bg: rgba(241, 245, 249, 0.8);
            --modal-bg: rgba(0, 0, 0, 0.4);
            --input-bg: #f8fafc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Hiragino Kaku Gothic ProN', 'Bisgiomar', 'Yu Gothic', 'Inter', system-ui, sans-serif;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            background: var(--header-bg);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--surface-hover);
        }

        .btn.primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn.primary:hover {
            background: var(--primary-hover);
        }

        .btn.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .btn-icon-only {
            padding: 0.5rem;
        }

        /* Filter Switcher */
        .filter-group {
            display: flex;
            gap: 0.5rem;
            padding: 4px;
            margin-right: 1rem;
            align-items: center;
        }

        .filter-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .filter-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.2s;
            border: 2px solid transparent;
            color: white;
        }

        .filter-btn.active {
            opacity: 1;
            transform: scale(1.1);
            border-color: var(--text-primary);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Status Bar */
        .status-indicator {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .dot.connected {
            background: var(--success-color);
            box-shadow: 0 0 8px var(--success-color);
        }

        .dot.syncing {
            background: var(--primary-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* --- Main Calendar --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* Enable vertical scrolling */
            padding: 0;
            /* Removed padding for sticky header */
            gap: 0;
            /* Handled by children padding/margin */
            opacity: 0.5;
            pointer-events: none;
            /* Disabled until DB connected */
            transition: opacity 0.3s;
            min-height: 0;
        }

        main.active {
            opacity: 1;
            pointer-events: all;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--header-bg);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid transparent;
            /* Optional transition for border */
        }

        .current-month {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: 40px repeat(6, minmax(0, auto));
            /* Dynamic height */
            border: 1px solid var(--grid-border);
            border-radius: 12px;
            background: var(--grid-border);
            gap: 1px;
            overflow: visible;
            flex-shrink: 0;
            margin: 1rem;
            /* Add margin since main has no padding */
        }

        .weekday {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-color);
            /* Need opaque bg */
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
            /* Remove border-bottom */
        }

        .day-cell {
            /* Remove borders */
            background: var(--surface-color);
            /* Opaque cell bg */
            padding: 8px;
            /* min-height is controlled by grid row */
            min-width: 0;
            /* Prevent grid blowout */
            position: relative;
            cursor: pointer;
            transition: background 0.1s;
        }



        .day-cell:hover {
            filter: brightness(1.2);
            /* Since bg is static, use filter or mix */
            background: var(--surface-hover);
        }

        .day-cell.other-month {
            background: var(--bg-color);
            /* Distinct dark bg */
            opacity: 1;
            /* Reset opacity since we use explicit color */
        }

        .day-cell:hover {
            background: var(--surface-hover);
        }

        .day-number {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            margin-left: 14px;
            margin-top: 8px;
        }

        .day-cell.is-saturday .day-number {
            color: #60a5fa;
            /* Light Blue */
        }

        .day-cell.is-sunday .day-number {
            color: #f87171;
            /* Light Red */
        }

        .day-cell.is-holiday .day-number {
            color: #f87171;
            /* Light Red */
        }

        .holiday-name {
            display: inline-block;
            font-size: 0.7rem;
            margin-left: 6px;
            color: #f87171;
            font-weight: normal;
        }

        .day-cell.today .day-number {
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-cell.other-month {
            background: rgba(0, 0, 0, 0.1);
            opacity: 0.5;
        }

        /* Events */
        .event-chip {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
        }

        .event-chip:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }

        .event-writer {
            opacity: 0.8;
            font-size: 0.7em;
            background: rgba(0, 0, 0, 0.2);
            padding: 0 4px;
            border-radius: 2px;
        }

        /* --- Event Completed Style --- */
        .event-chip.completed {
            opacity: 0.6;
            text-decoration: line-through;
            border-style: dashed;
        }

        .event-chip.completed::after {
            content: "âœ“";
            margin-left: 4px;
            font-weight: bold;
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            backdrop-filter: blur(4px);
            display: none;
            place-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .modal-overlay.open {
            display: grid;
            opacity: 1;
        }

        .modal {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 95%;
            max-width: 600px;
            /* Wider */
            max-height: 90vh;
            /* Allow tall modal */
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            transform: scale(0.95);
            transition: transform 0.2s;
            display: flex;
            /* Flex layout to handle scrolling inside */
            flex-direction: column;
        }

        .modal-overlay.open .modal {
            transform: scale(1);
        }

        .modal-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text-primary);
            outline: none;
            font-size: 1rem;
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary-color);
        }

        /* Radio Group for Categories */
        .category-selector {
            display: flex;
            flex-wrap: wrap;
            /* Fix layout */
            gap: 0.75rem;
            background: var(--input-bg);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px;
        }

        .radio-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            position: relative;
        }

        input[type="radio"] {
            display: none;
        }

        input[type="radio"]:checked+.radio-circle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* User Management */
        .user-list {
            display: flex;
            flex-direction: column;
            /* 1 person per row */
            gap: 0.5rem;

            /* Target: 20 rows. 
               If 1 row is approx 40px: 20 * 40 = 800px.
               Use vh to be safe, but set min-height or explicit height if screen allows.
            */
            height: 60vh;
            min-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 4px;
            border: 1px solid var(--border-color);
            /* Add border for list area */
            border-radius: 8px;
        }

        .user-chip {
            background: var(--surface-hover);
            padding: 0.75rem 1rem;
            /* Larger touch area */
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            /* Larger text */
        }

        .user-chip .delete-btn {
            color: var(--danger-color);
            cursor: pointer;
            padding: 2px;
            margin-left: 4px;
        }

        /* Checkbox Grid for Writers */
        .writer-checkboxes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            background: var(--input-bg);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .writer-option {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.1s;
        }

        .writer-option:hover {
            background: var(--surface-hover);
        }

        .writer-option input {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        /* Intro Barrier */
        .intro-barrier {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .intro-barrier h2 {
            margin-bottom: 0.5rem;
        }

        .intro-barrier p {
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Board View Styles */
        .board-view {
            display: none;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            padding-right: 4px;
        }

        .board-view.active {
            display: flex;
        }

        .board-row {
            display: grid;
            grid-template-columns: 11rem 1fr;
            /* Wider user label ~7 chars */
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .board-user-label {
            background: var(--surface-color);
            padding: 0.5rem;
            /* Reduced padding */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-right: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .board-timeline {
            padding: 0.5rem;
            min-height: 80px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        /* View Switcher */
        .view-switcher {
            display: flex;
            background: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }

            body {
                background: white;
                color: black !important;
                height: auto;
                overflow: visible;
                display: block;
                font-size: 10pt;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Hide interactive/non-essential elements */
            header,
            .intro-barrier,
            .modal-overlay,
            .controls,
            .filter-group,
            .btn,
            .view-switcher {
                display: none !important;
            }

            /* Main Layout */
            main {
                display: block !important;
                opacity: 1 !important;
                padding: 0;
                margin: 0;
                overflow: visible !important;
            }

            .calendar-header {
                justify-content: center;
                margin: 0 0 0.5rem 0;
                padding: 0;
            }

            /* Helper: spacing for the month header */
            .calendar-header div[style*="width: 120px"],
            .calendar-header .controls {
                display: none !important;
            }

            .current-month {
                color: black;
                font-size: 1.2rem;
                margin: 0;
            }

            /* Grid Bordering */
            .calendar-grid {
                border: 2px solid #000;
                background: transparent;
                gap: 0;
                display: grid;
                /* Reset explicit row heights for print - use auto to fit content */
                grid-template-rows: 20px repeat(6, auto) !important;
                height: auto !important;
                page-break-inside: auto;
            }

            .weekday {
                background: #eee !important;
                color: black !important;
                border: 1px solid #000;
                font-size: 0.8rem;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .day-cell {
                background: white !important;
                border: 1px solid #000;
                min-height: 80px;
                /* Ensure some height */
                height: auto !important;
                /* Grow with content */
                page-break-inside: avoid;
                padding: 2px;
                overflow: visible !important;
            }

            .day-cell.other-month {
                background: #f9f9f9 !important;
                opacity: 1;
            }

            .day-number {
                font-size: 0.7rem;
                margin: 0 0 2px 2px;
                color: black !important;
            }

            /* Holiday/Weekend Colors Override to Black for strict B/W request? 
               User said "å°åˆ·æ™‚ã®æ–‡å­—è‰²ã¯é»’1è‰²" (Text color black single color). 
               But usually dates are okay to be distinctive if greyscale. 
               However, strictly interpreting "Text color is black 1 color".
            */
            .day-cell.is-saturday .day-number,
            .day-cell.is-sunday .day-number,
            .day-cell.is-holiday .day-number {
                color: black !important;
            }

            .holiday-name {
                color: black !important;
                font-size: 0.6rem;
            }

            .day-cell.today .day-number {
                background: transparent !important;
                color: black !important;
                border: 1px solid black;
            }

            /* Event Styling */
            .event-chip {
                background: transparent !important;
                color: black !important;
                border: none !important;
                /* Minimal look to save space */
                box-shadow: none;
                margin-bottom: 2px;
                padding: 0;
                font-size: 0.65rem !important;
                /* Small font */
                line-height: 1.1;

                /* Wrap text */
                white-space: normal !important;
                height: auto !important;
                display: block !important;
                max-height: none !important;
            }

            /* Hide Category Prefixes (User Requirement 1) */
            .event-chip::before {
                content: none !important;
                display: none !important;
            }

            /* Hide Background patterns/colors */
            .event-chip[data-category="cat_private"] {
                background: transparent !important;
            }

            .event-writer {
                background: transparent !important;
                border: none !important;
                color: black !important;
                font-weight: bold;
                margin-right: 2px;
                font-size: inherit;
                display: inline;
                padding: 0;
            }

            /* Construct the layout: Time + Writer + Title */
            .event-chip {
                border-bottom: 1px dotted #ccc !important;
                padding-bottom: 1px;
            }

            /* Ensure inner spans (Title/Time) wraps and overrides inline styles */
            .event-chip span {
                white-space: normal !important;
                overflow: visible !important;
                text-overflow: unset !important;
            }

            .event-chip .event-time {
                /* If we had a time span, but currently it's just text in the chip? 
                   We need to see how event chip HTML is built.
                   Assuming the text is inside.
                */
                display: inline;
                font-weight: bold;
                margin-right: 2px;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            TeamSync <span style="font-size:0.8em; opacity:0.7; font-weight:normal;">å…±åŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</span>
        </div>

        <div class="controls">
            <div class="status-indicator">
                <div id="statusDot" class="dot"></div>
                <span id="statusText">æœªæ¥ç¶š</span>
            </div>

            <div class="filter-group" id="filterGroup">
                <span class="filter-label">è¡¨ç¤º:</span>
                <!-- Injected by JS -->
            </div>

            <button class="btn" onclick="toggleTheme()" id="btnTheme" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                <svg id="themeIconSun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" style="display:none;">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg id="themeIconMoon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
                <span>ãƒ†ãƒ¼ãƒ</span>
            </button>

            <button class="btn" onclick="openUserModal()" id="btnUsers">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š
            </button>
            <button class="btn primary" onclick="connectDatabase()" id="btnConnect">
                ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (å…±æœ‰)
            </button>
        </div>
    </header>

    <div class="intro-barrier" id="introBarrier">
        <h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦é–‹å§‹</h2>
        <p>å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ä¸Šã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆã¾ãŸã¯ä½œæˆï¼‰ã—ã¦ãã ã•ã„ã€‚<br>è‡ªå‹•çš„ã«åŒæœŸã•ã‚Œã€è¤‡æ•°äººã§ã®ç·¨é›†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
        <button class="btn primary" onclick="connectDatabase()"
            style="margin-top:1rem; font-size:1.1rem; padding: 0.8rem 1.5rem;">
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã / æ–°è¦ä½œæˆ
        </button>
    </div>

    <main id="mainContent">
        <div class="calendar-header">
            <div class="controls">
                <button class="btn btn-icon-only" onclick="navigateDate(-1)">&lt;</button>
                <button class="btn btn-icon-only" onclick="navigateDate(1)">&gt;</button>
                <button class="btn" onclick="goToToday()">ä»Šæ—¥</button>
            </div>
            <h2 class="current-month" id="monthLabel">2026å¹´ 1æœˆ</h2>
            <div class="view-switcher">
                <div class="view-btn active" onclick="switchView('month')" id="btnViewMonth">æœˆ</div>
                <div class="view-btn" onclick="switchView('day')" id="btnViewDay">æ—¥</div>
            </div>
        </div>

        <div class="calendar-grid" id="calendarGrid">
            <!-- Weekdays -->
            <div class="weekday">æ—¥</div>
            <div class="weekday">æœˆ</div>
            <div class="weekday">ç«</div>
            <div class="weekday">æ°´</div>
            <div class="weekday">æœ¨</div>
            <div class="weekday">é‡‘</div>
            <div class="weekday">åœŸ</div>
            <!-- Days injected -->
        </div>

        <div class="board-view" id="boardView">
            <!-- Board injected -->
        </div>
    </main>

    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">äºˆå®šã‚’è¿½åŠ </h3>
                <button class="btn btn-icon-only" onclick="closeModal()"
                    style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div class="form-group">
                <label>ç¨®åˆ¥</label>
                <div class="category-selector" id="modalCategorySelector">
                    <!-- JS injected options -->
                </div>
            </div>
            <div class="form-group">
                <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="eventTitle" placeholder="ä¼šè­°, æ‰“ã¡åˆã‚ã›ç­‰...">
            </div>
            <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">
                <div>
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="eventDate">
                </div>
                <div>
                    <label>æ™‚é–“</label>
                    <input type="time" id="eventTime">
                </div>
            </div>
            <div class="form-group">
                <label>æ°å (è¤‡æ•°é¸æŠå¯)</label>
                <div class="writer-checkboxes" id="writerCheckboxes">
                    <!-- JS injected -->
                </div>
            </div>
            <div class="form-group">
                <label>è©³ç´° / ãƒ¡ãƒ¢</label>
                <textarea id="eventDesc" rows="3" placeholder="è©³ç´°ã‚’å…¥åŠ›..."></textarea>
            </div>
            <div class="form-group" style="display:flex; align-items:center;">
                <label style="margin-bottom:0; cursor:pointer; display:flex; align-items:center; gap:0.5rem;">
                    <input type="checkbox" id="eventCompleted" style="width:20px; height:20px;">
                    <span>å®Œäº†ã¨ã—ã¦ãƒãƒ¼ã‚¯</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="deleteEvent()" id="btnDelete"
                    style="display:none; color: var(--danger-color); border-color:var(--danger-color);">å‰Šé™¤</button>
                <button class="btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn primary" onclick="saveEvent()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š (æœ€å¤§99å)</h3>
                <button class="btn btn-icon-only" onclick="closeUserModal()"
                    style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div class="form-group">
                <div class="user-list" id="userListDisplay">
                    <!-- JS Injected -->
                </div>
            </div>
            <div class="form-group" style="display:flex; gap:0.5rem;">
                <input type="text" id="newUserName" placeholder="æ–°ã—ã„æ°åã‚’å…¥åŠ›...">
                <button class="btn primary" onclick="addUser()">è¿½åŠ </button>
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

            <div class="form-group">
                <h4 style="margin-bottom:0.5rem; font-size:1rem;">ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn" onclick="exportPrivateData()">
                        ğŸ”’ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn" onclick="document.getElementById('importFile').click()">
                        ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display:none;"
                        onchange="importPrivateData(this)">
                </div>
                <p style="font-size:0.75rem; color:var(--text-secondary); margin-top:0.5rem;">
                    ã€Œç§˜ã€ã‚«ãƒ†ã‚´ãƒªã®äºˆå®šã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ç§»è¡Œæ™‚ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CATEGORIES = [
            { id: 'cat_zen', name: 'å…¨', color: 'var(--cat-zen)' },
            { id: 'cat_sei', name: 'æ•´', color: 'var(--cat-sei)' },
            { id: 'cat_toku', name: 'ç‰¹', color: 'var(--cat-toku)' },
            { id: 'cat_cho', name: 'èª¿', color: 'var(--cat-cho)' },
            { id: 'cat_tou', name: 'å½“', color: 'var(--cat-tou)' },
            { id: 'cat_kyu', name: 'ä¼‘', color: 'var(--cat-kyu)' },
            { id: 'cat_private', name: 'ç§˜', color: 'var(--cat-private)', isPrivate: true },
        ];

        // Holiday Data (2025-2050)
        const HOLIDAYS = {
            "2025-04-29": "æ˜­å’Œã®æ—¥", "2025-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2025-05-04": "ã¿ã©ã‚Šã®æ—¥", "2025-05-05": "ã“ã©ã‚‚ã®æ—¥", "2025-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2025-07-21": "æµ·ã®æ—¥", "2025-08-11": "å±±ã®æ—¥", "2025-09-15": "æ•¬è€ã®æ—¥", "2025-09-23": "ç§‹åˆ†ã®æ—¥", "2025-10-13": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2025-11-03": "æ–‡åŒ–ã®æ—¥", "2025-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥", "2025-11-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2026-01-01": "å…ƒæ—¥", "2026-01-12": "æˆäººã®æ—¥", "2026-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2026-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2026-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2026-04-29": "æ˜­å’Œã®æ—¥", "2026-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2026-05-04": "ã¿ã©ã‚Šã®æ—¥", "2026-05-05": "ã“ã©ã‚‚ã®æ—¥", "2026-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2026-07-20": "æµ·ã®æ—¥", "2026-08-11": "å±±ã®æ—¥", "2026-09-21": "æ•¬è€ã®æ—¥", "2026-09-22": "å›½æ°‘ã®ä¼‘æ—¥", "2026-09-23": "ç§‹åˆ†ã®æ—¥",
            "2026-10-12": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2026-11-03": "æ–‡åŒ–ã®æ—¥", "2026-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2027-01-01": "å…ƒæ—¥", "2027-01-11": "æˆäººã®æ—¥", "2027-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2027-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2027-03-21": "æ˜¥åˆ†ã®æ—¥",
            "2027-03-22": "æŒ¯æ›¿ä¼‘æ—¥", "2027-04-29": "æ˜­å’Œã®æ—¥", "2027-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2027-05-04": "ã¿ã©ã‚Šã®æ—¥", "2027-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2027-07-19": "æµ·ã®æ—¥", "2027-08-11": "å±±ã®æ—¥", "2027-09-20": "æ•¬è€ã®æ—¥", "2027-09-23": "ç§‹åˆ†ã®æ—¥", "2027-10-11": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2027-11-03": "æ–‡åŒ–ã®æ—¥", "2027-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2028-01-01": "å…ƒæ—¥", "2028-01-10": "æˆäººã®æ—¥", "2028-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2028-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2028-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2028-04-29": "æ˜­å’Œã®æ—¥", "2028-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2028-05-04": "ã¿ã©ã‚Šã®æ—¥", "2028-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2028-07-17": "æµ·ã®æ—¥", "2028-08-11": "å±±ã®æ—¥", "2028-09-18": "æ•¬è€ã®æ—¥", "2028-09-22": "ç§‹åˆ†ã®æ—¥", "2028-10-09": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2028-11-03": "æ–‡åŒ–ã®æ—¥", "2028-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2029-01-01": "å…ƒæ—¥", "2029-01-08": "æˆäººã®æ—¥", "2029-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2029-02-12": "æŒ¯æ›¿ä¼‘æ—¥", "2029-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
            "2029-03-20": "æ˜¥åˆ†ã®æ—¥", "2029-04-29": "æ˜­å’Œã®æ—¥", "2029-04-30": "æŒ¯æ›¿ä¼‘æ—¥", "2029-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2029-05-04": "ã¿ã©ã‚Šã®æ—¥",
            "2029-05-05": "ã“ã©ã‚‚ã®æ—¥", "2029-07-16": "æµ·ã®æ—¥", "2029-08-11": "å±±ã®æ—¥", "2029-09-17": "æ•¬è€ã®æ—¥", "2029-09-23": "ç§‹åˆ†ã®æ—¥",
            "2029-09-24": "æŒ¯æ›¿ä¼‘æ—¥", "2029-10-08": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2029-11-03": "æ–‡åŒ–ã®æ—¥", "2029-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2030-01-01": "å…ƒæ—¥", "2030-01-14": "æˆäººã®æ—¥", "2030-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2030-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2030-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2030-04-29": "æ˜­å’Œã®æ—¥", "2030-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2030-05-04": "ã¿ã©ã‚Šã®æ—¥", "2030-05-05": "ã“ã©ã‚‚ã®æ—¥", "2030-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2030-07-15": "æµ·ã®æ—¥", "2030-08-11": "å±±ã®æ—¥", "2030-08-12": "æŒ¯æ›¿ä¼‘æ—¥", "2030-09-16": "æ•¬è€ã®æ—¥", "2030-09-23": "ç§‹åˆ†ã®æ—¥",
            "2030-10-14": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2030-11-03": "æ–‡åŒ–ã®æ—¥", "2030-11-04": "æŒ¯æ›¿ä¼‘æ—¥", "2030-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2031-01-01": "å…ƒæ—¥", "2031-01-13": "æˆäººã®æ—¥", "2031-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2031-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2031-02-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2031-03-21": "æ˜¥åˆ†ã®æ—¥", "2031-04-29": "æ˜­å’Œã®æ—¥", "2031-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2031-05-04": "ã¿ã©ã‚Šã®æ—¥", "2031-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2031-05-06": "æŒ¯æ›¿ä¼‘æ—¥", "2031-07-21": "æµ·ã®æ—¥", "2031-08-11": "å±±ã®æ—¥", "2031-09-15": "æ•¬è€ã®æ—¥", "2031-09-23": "ç§‹åˆ†ã®æ—¥",
            "2031-10-13": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2031-11-03": "æ–‡åŒ–ã®æ—¥", "2031-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥", "2031-11-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2032-01-01": "å…ƒæ—¥", "2032-01-12": "æˆäººã®æ—¥", "2032-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2032-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2032-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2032-04-29": "æ˜­å’Œã®æ—¥", "2032-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2032-05-04": "ã¿ã©ã‚Šã®æ—¥", "2032-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2032-07-19": "æµ·ã®æ—¥", "2032-08-11": "å±±ã®æ—¥", "2032-09-20": "æ•¬è€ã®æ—¥", "2032-09-21": "å›½æ°‘ã®ä¼‘æ—¥", "2032-09-22": "ç§‹åˆ†ã®æ—¥",
            "2032-10-11": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2032-11-03": "æ–‡åŒ–ã®æ—¥", "2032-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2033-01-01": "å…ƒæ—¥", "2033-01-10": "æˆäººã®æ—¥", "2033-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2033-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2033-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2033-03-21": "æŒ¯æ›¿ä¼‘æ—¥", "2033-04-29": "æ˜­å’Œã®æ—¥", "2033-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2033-05-04": "ã¿ã©ã‚Šã®æ—¥", "2033-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2033-07-18": "æµ·ã®æ—¥", "2033-08-11": "å±±ã®æ—¥", "2033-09-19": "æ•¬è€ã®æ—¥", "2033-09-23": "ç§‹åˆ†ã®æ—¥", "2033-10-10": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2033-11-03": "æ–‡åŒ–ã®æ—¥", "2033-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2034-01-01": "å…ƒæ—¥", "2034-01-02": "æŒ¯æ›¿ä¼‘æ—¥", "2034-01-09": "æˆäººã®æ—¥", "2034-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2034-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
            "2034-03-20": "æ˜¥åˆ†ã®æ—¥", "2034-04-29": "æ˜­å’Œã®æ—¥", "2034-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2034-05-04": "ã¿ã©ã‚Šã®æ—¥", "2034-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2034-07-17": "æµ·ã®æ—¥", "2034-08-11": "å±±ã®æ—¥", "2034-09-18": "æ•¬è€ã®æ—¥", "2034-09-23": "ç§‹åˆ†ã®æ—¥", "2034-10-09": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2034-11-03": "æ–‡åŒ–ã®æ—¥", "2034-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2035-01-01": "å…ƒæ—¥", "2035-01-08": "æˆäººã®æ—¥", "2035-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2035-02-12": "æŒ¯æ›¿ä¼‘æ—¥", "2035-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
            "2035-03-21": "æ˜¥åˆ†ã®æ—¥", "2035-04-29": "æ˜­å’Œã®æ—¥", "2035-04-30": "æŒ¯æ›¿ä¼‘æ—¥", "2035-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2035-05-04": "ã¿ã©ã‚Šã®æ—¥",
            "2035-05-05": "ã“ã©ã‚‚ã®æ—¥", "2035-07-16": "æµ·ã®æ—¥", "2035-08-11": "å±±ã®æ—¥", "2035-09-17": "æ•¬è€ã®æ—¥", "2035-09-23": "ç§‹åˆ†ã®æ—¥",
            "2035-09-24": "æŒ¯æ›¿ä¼‘æ—¥", "2035-10-08": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2035-11-03": "æ–‡åŒ–ã®æ—¥", "2035-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2036-01-01": "å…ƒæ—¥", "2036-01-14": "æˆäººã®æ—¥", "2036-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2036-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2036-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2036-04-29": "æ˜­å’Œã®æ—¥", "2036-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2036-05-04": "ã¿ã©ã‚Šã®æ—¥", "2036-05-05": "ã“ã©ã‚‚ã®æ—¥", "2036-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2036-07-21": "æµ·ã®æ—¥", "2036-08-11": "å±±ã®æ—¥", "2036-09-15": "æ•¬è€ã®æ—¥", "2036-09-22": "ç§‹åˆ†ã®æ—¥", "2036-10-13": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2036-11-03": "æ–‡åŒ–ã®æ—¥", "2036-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥", "2036-11-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2037-01-01": "å…ƒæ—¥", "2037-01-12": "æˆäººã®æ—¥", "2037-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2037-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2037-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2037-04-29": "æ˜­å’Œã®æ—¥", "2037-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2037-05-04": "ã¿ã©ã‚Šã®æ—¥", "2037-05-05": "ã“ã©ã‚‚ã®æ—¥", "2037-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2037-07-20": "æµ·ã®æ—¥", "2037-08-11": "å±±ã®æ—¥", "2037-09-21": "æ•¬è€ã®æ—¥", "2037-09-22": "å›½æ°‘ã®ä¼‘æ—¥", "2037-09-23": "ç§‹åˆ†ã®æ—¥",
            "2037-10-12": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2037-11-03": "æ–‡åŒ–ã®æ—¥", "2037-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2038-01-01": "å…ƒæ—¥", "2038-01-11": "æˆäººã®æ—¥", "2038-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2038-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2038-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2038-04-29": "æ˜­å’Œã®æ—¥", "2038-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2038-05-04": "ã¿ã©ã‚Šã®æ—¥", "2038-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2038-07-19": "æµ·ã®æ—¥", "2038-08-11": "å±±ã®æ—¥", "2038-09-20": "æ•¬è€ã®æ—¥", "2038-09-23": "ç§‹åˆ†ã®æ—¥", "2038-10-11": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2038-11-03": "æ–‡åŒ–ã®æ—¥", "2038-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2039-01-01": "å…ƒæ—¥", "2039-01-10": "æˆäººã®æ—¥", "2039-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2039-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2039-03-21": "æ˜¥åˆ†ã®æ—¥",
            "2039-04-29": "æ˜­å’Œã®æ—¥", "2039-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2039-05-04": "ã¿ã©ã‚Šã®æ—¥", "2039-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2039-07-18": "æµ·ã®æ—¥", "2039-08-11": "å±±ã®æ—¥", "2039-09-19": "æ•¬è€ã®æ—¥", "2039-09-23": "ç§‹åˆ†ã®æ—¥", "2039-10-10": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2039-11-03": "æ–‡åŒ–ã®æ—¥", "2039-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2040-01-01": "å…ƒæ—¥", "2040-01-02": "æŒ¯æ›¿ä¼‘æ—¥", "2040-01-09": "æˆäººã®æ—¥", "2040-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2040-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
            "2040-03-20": "æ˜¥åˆ†ã®æ—¥", "2040-04-29": "æ˜­å’Œã®æ—¥", "2040-04-30": "æŒ¯æ›¿ä¼‘æ—¥", "2040-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2040-05-04": "ã¿ã©ã‚Šã®æ—¥",
            "2040-05-05": "ã“ã©ã‚‚ã®æ—¥", "2040-07-16": "æµ·ã®æ—¥", "2040-08-11": "å±±ã®æ—¥", "2040-09-17": "æ•¬è€ã®æ—¥", "2040-09-22": "ç§‹åˆ†ã®æ—¥",
            "2040-10-08": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2040-11-03": "æ–‡åŒ–ã®æ—¥", "2040-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2041-01-01": "å…ƒæ—¥", "2041-01-14": "æˆäººã®æ—¥", "2041-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2041-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2041-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2041-04-29": "æ˜­å’Œã®æ—¥", "2041-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2041-05-04": "ã¿ã©ã‚Šã®æ—¥", "2041-05-05": "ã“ã©ã‚‚ã®æ—¥", "2041-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2041-07-15": "æµ·ã®æ—¥", "2041-08-11": "å±±ã®æ—¥", "2041-08-12": "æŒ¯æ›¿ä¼‘æ—¥", "2041-09-16": "æ•¬è€ã®æ—¥", "2041-09-23": "ç§‹åˆ†ã®æ—¥",
            "2041-10-14": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2041-11-03": "æ–‡åŒ–ã®æ—¥", "2041-11-04": "æŒ¯æ›¿ä¼‘æ—¥", "2041-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2042-01-01": "å…ƒæ—¥", "2042-01-13": "æˆäººã®æ—¥", "2042-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2042-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2042-02-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2042-03-20": "æ˜¥åˆ†ã®æ—¥", "2042-04-29": "æ˜­å’Œã®æ—¥", "2042-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2042-05-04": "ã¿ã©ã‚Šã®æ—¥", "2042-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2042-05-06": "æŒ¯æ›¿ä¼‘æ—¥", "2042-07-21": "æµ·ã®æ—¥", "2042-08-11": "å±±ã®æ—¥", "2042-09-15": "æ•¬è€ã®æ—¥", "2042-09-23": "ç§‹åˆ†ã®æ—¥",
            "2042-10-13": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2042-11-03": "æ–‡åŒ–ã®æ—¥", "2042-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥", "2042-11-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2043-01-01": "å…ƒæ—¥", "2043-01-12": "æˆäººã®æ—¥", "2043-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2043-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2043-03-21": "æ˜¥åˆ†ã®æ—¥",
            "2043-04-29": "æ˜­å’Œã®æ—¥", "2043-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2043-05-04": "ã¿ã©ã‚Šã®æ—¥", "2043-05-05": "ã“ã©ã‚‚ã®æ—¥", "2043-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2043-07-20": "æµ·ã®æ—¥", "2043-08-11": "å±±ã®æ—¥", "2043-09-21": "æ•¬è€ã®æ—¥", "2043-09-22": "å›½æ°‘ã®ä¼‘æ—¥", "2043-09-23": "ç§‹åˆ†ã®æ—¥",
            "2043-10-12": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2043-11-03": "æ–‡åŒ–ã®æ—¥", "2043-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2044-01-01": "å…ƒæ—¥", "2044-01-11": "æˆäººã®æ—¥", "2044-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2044-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2044-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2044-03-21": "æŒ¯æ›¿ä¼‘æ—¥", "2044-04-29": "æ˜­å’Œã®æ—¥", "2044-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2044-05-04": "ã¿ã©ã‚Šã®æ—¥", "2044-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2044-07-18": "æµ·ã®æ—¥", "2044-08-11": "å±±ã®æ—¥", "2044-09-19": "æ•¬è€ã®æ—¥", "2044-09-22": "ç§‹åˆ†ã®æ—¥", "2044-10-10": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2044-11-03": "æ–‡åŒ–ã®æ—¥", "2044-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2045-01-01": "å…ƒæ—¥", "2045-01-02": "æŒ¯æ›¿ä¼‘æ—¥", "2045-01-09": "æˆäººã®æ—¥", "2045-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2045-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
            "2045-03-20": "æ˜¥åˆ†ã®æ—¥", "2045-04-29": "æ˜­å’Œã®æ—¥", "2045-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2045-05-04": "ã¿ã©ã‚Šã®æ—¥", "2045-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2045-07-17": "æµ·ã®æ—¥", "2045-08-11": "å±±ã®æ—¥", "2045-09-18": "æ•¬è€ã®æ—¥", "2045-09-22": "ç§‹åˆ†ã®æ—¥", "2045-10-09": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2045-11-03": "æ–‡åŒ–ã®æ—¥", "2045-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2046-01-01": "å…ƒæ—¥", "2046-01-08": "æˆäººã®æ—¥", "2046-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2046-02-12": "æŒ¯æ›¿ä¼‘æ—¥", "2046-02-23": "å¤©çš‡èª•ç”Ÿæ—¥",
            "2046-03-20": "æ˜¥åˆ†ã®æ—¥", "2046-04-29": "æ˜­å’Œã®æ—¥", "2046-04-30": "æŒ¯æ›¿ä¼‘æ—¥", "2046-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2046-05-04": "ã¿ã©ã‚Šã®æ—¥",
            "2046-05-05": "ã“ã©ã‚‚ã®æ—¥", "2046-07-16": "æµ·ã®æ—¥", "2046-08-11": "å±±ã®æ—¥", "2046-09-17": "æ•¬è€ã®æ—¥", "2046-09-23": "ç§‹åˆ†ã®æ—¥",
            "2046-09-24": "æŒ¯æ›¿ä¼‘æ—¥", "2046-10-08": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2046-11-03": "æ–‡åŒ–ã®æ—¥", "2046-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2047-01-01": "å…ƒæ—¥", "2047-01-14": "æˆäººã®æ—¥", "2047-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2047-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2047-03-21": "æ˜¥åˆ†ã®æ—¥",
            "2047-04-29": "æ˜­å’Œã®æ—¥", "2047-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2047-05-04": "ã¿ã©ã‚Šã®æ—¥", "2047-05-05": "ã“ã©ã‚‚ã®æ—¥", "2047-05-06": "æŒ¯æ›¿ä¼‘æ—¥",
            "2047-07-15": "æµ·ã®æ—¥", "2047-08-11": "å±±ã®æ—¥", "2047-08-12": "æŒ¯æ›¿ä¼‘æ—¥", "2047-09-16": "æ•¬è€ã®æ—¥", "2047-09-23": "ç§‹åˆ†ã®æ—¥",
            "2047-10-14": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2047-11-03": "æ–‡åŒ–ã®æ—¥", "2047-11-04": "æŒ¯æ›¿ä¼‘æ—¥", "2047-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2048-01-01": "å…ƒæ—¥", "2048-01-13": "æˆäººã®æ—¥", "2048-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2048-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2048-02-24": "æŒ¯æ›¿ä¼‘æ—¥",
            "2048-03-20": "æ˜¥åˆ†ã®æ—¥", "2048-04-29": "æ˜­å’Œã®æ—¥", "2048-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2048-05-04": "ã¿ã©ã‚Šã®æ—¥", "2048-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2048-05-06": "æŒ¯æ›¿ä¼‘æ—¥", "2048-07-20": "æµ·ã®æ—¥", "2048-08-11": "å±±ã®æ—¥", "2048-09-21": "æ•¬è€ã®æ—¥", "2048-09-22": "ç§‹åˆ†ã®æ—¥",
            "2048-10-12": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2048-11-03": "æ–‡åŒ–ã®æ—¥", "2048-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2049-01-01": "å…ƒæ—¥", "2049-01-11": "æˆäººã®æ—¥", "2049-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2049-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2049-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2049-04-29": "æ˜­å’Œã®æ—¥", "2049-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2049-05-04": "ã¿ã©ã‚Šã®æ—¥", "2049-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2049-07-19": "æµ·ã®æ—¥", "2049-08-11": "å±±ã®æ—¥", "2049-09-20": "æ•¬è€ã®æ—¥", "2049-09-21": "å›½æ°‘ã®ä¼‘æ—¥", "2049-09-22": "ç§‹åˆ†ã®æ—¥",
            "2049-10-11": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "2049-11-03": "æ–‡åŒ–ã®æ—¥", "2049-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
            "2050-01-01": "å…ƒæ—¥", "2050-01-10": "æˆäººã®æ—¥", "2050-02-11": "å»ºå›½è¨˜å¿µã®æ—¥", "2050-02-23": "å¤©çš‡èª•ç”Ÿæ—¥", "2050-03-20": "æ˜¥åˆ†ã®æ—¥",
            "2050-03-21": "æŒ¯æ›¿ä¼‘æ—¥", "2050-04-29": "æ˜­å’Œã®æ—¥", "2050-05-03": "æ†²æ³•è¨˜å¿µæ—¥", "2050-05-04": "ã¿ã©ã‚Šã®æ—¥", "2050-05-05": "ã“ã©ã‚‚ã®æ—¥",
            "2050-07-18": "æµ·ã®æ—¥", "2050-08-11": "å±±ã®æ—¥", "2050-09-19": "æ•¬è€ã®æ—¥", "2050-09-23": "ç§‹åˆ†ã®æ—¥", "2050-10-10": "ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥",
            "2050-11-03": "æ–‡åŒ–ã®æ—¥", "2050-11-23": "å‹¤åŠ´æ„Ÿè¬ã®æ—¥",
        };

        // --- State ---
        let state = {
            currentDate: new Date(),
            activeFilters: new Set(CATEGORIES.map(c => c.id)),
            users: [], // List of registered names (Master list from file)
            userOrder: [], // Local preference for order
            events: [],
            viewMode: 'month', // 'month' or 'day'
            lastSelectedCategory: 'cat_zen',
            lastSelectedWriters: [],
            theme: 'dark'
        };

        // --- Theme Management ---
        async function initTheme() {
            const savedTheme = await getPref('theme') || 'dark';
            state.theme = savedTheme;
            applyTheme();
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            setPref('theme', state.theme);
            applyTheme();
        }

        function applyTheme() {
            const isLight = state.theme === 'light';
            document.documentElement.classList.toggle('light-mode', isLight);
            document.getElementById('themeIconSun').style.display = isLight ? 'block' : 'none';
            document.getElementById('themeIconMoon').style.display = isLight ? 'none' : 'block';
        }

        // --- Persistence Constants ---
        const PREF_LAST_CAT = 'lastSelectedCategory';
        const PREF_LAST_WRITERS = 'lastSelectedWriters';
        const PREF_USER_ORDER = 'userSortOrder';

        let fileHandle = null;
        let filePoller = null;
        let lastModifiedTime = 0;

        let editingEventId = null;

        // --- IndexedDB Manager ---
        const DB_NAME = 'TeamSyncDB';
        const STORE_NAME = 'prefs';
        const STORE_PRIVATE = 'private_events';
        let db = null;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 2);

                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                    if (!db.objectStoreNames.contains(STORE_PRIVATE)) {
                        db.createObjectStore(STORE_PRIVATE, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };

                request.onerror = (e) => reject(e);
            });
        }

        async function setPref(key, value) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(value, key);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        }

        async function getPref(key) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject();
            });
        }

        // --- Core Logic: Initialize ---

        async function init() {
            await initDB();

            // 0. Theme
            await initTheme();

            // 1. Writer Name
            const search = window.location.search;
            let urlName = '';
            if (search) {
                if (search.startsWith("?name=")) urlName = decodeURIComponent(search.substring(6));
                else if (search.startsWith("?=")) urlName = decodeURIComponent(search.substring(2));
                else urlName = decodeURIComponent(search.substring(1));
            }

            if (urlName) {
                state.writerName = urlName;
                setPref('writerName', urlName);
            } else {
                const savedName = await getPref('writerName');
                if (savedName) state.writerName = savedName;
            }

            // 2. Filter Logic
            const savedFilters = await getPref('activeFilters');
            if (savedFilters && Array.isArray(savedFilters) && savedFilters.length > 0) {
                // Need to validate if saved filters exist in current CATEGORIES
                // If outdated IDs (like u1, cat_a) exist, they won't match, so fallback to all
                const validSaved = savedFilters.filter(id => CATEGORIES.some(c => c.id === id));
                if (validSaved.length > 0) {
                    state.activeFilters = new Set(validSaved);
                }
            }

            // 4. Persistence Load
            const savedLastCat = await getPref(PREF_LAST_CAT);
            if (savedLastCat) state.lastSelectedCategory = savedLastCat;

            const savedLastWriters = await getPref(PREF_LAST_WRITERS);
            if (savedLastWriters) state.lastSelectedWriters = savedLastWriters;

            // Check for saved file handle
            try {
                const savedHandle = await getPref('lastFileHandle');
                if (savedHandle) {
                    const btn = document.querySelector('#introBarrier .btn');
                    btn.textContent = 'å†æ¥ç¶š: ' + savedHandle.name;
                    btn.onclick = () => reconnectDatabase(savedHandle);

                    const headBtn = document.getElementById('btnConnect');
                    headBtn.textContent = 'å†æ¥ç¶š: ' + savedHandle.name;
                    headBtn.onclick = () => reconnectDatabase(savedHandle);
                }
            } catch (e) { console.warn('No saved handle', e); }

            // 5. Render
            renderFilters();
            renderModalSelector();
            renderCalendar();
            renderViewSwitcher();
        }

        // --- File System Access ---

        async function connectDatabase() {
            try {
                try {
                    [fileHandle] = await window.showOpenFilePicker({
                        types: [{ description: 'Scheduler Data JSON', accept: { 'application/json': ['.json'] } }],
                        multiple: false
                    });
                    await setPref('lastFileHandle', fileHandle); // Save handle
                } catch (e) {
                    if (confirm("æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã‹ï¼Ÿæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) {
                        fileHandle = await window.showSaveFilePicker({
                            suggestedName: 'scheduler_data.json',
                            types: [{ description: 'Scheduler Data JSON', accept: { 'application/json': ['.json'] } }]
                        });
                        await setPref('lastFileHandle', fileHandle); // Save handle
                        state.events = [];
                        await writeToFile(state.events);
                    } else {
                        return;
                    }
                }

                await loadFromFile();

                if (filePoller) clearInterval(filePoller);
                filePoller = setInterval(checkFileUpdates, 3000);

                document.getElementById('introBarrier').style.display = 'none';
                document.getElementById('mainContent').classList.add('active');
                document.getElementById('btnConnect').textContent = 'æ¥ç¶šæ¸ˆã¿: ' + fileHandle.name;
                document.getElementById('btnConnect').classList.add('success');
                document.getElementById('btnConnect').classList.remove('primary');
                updateStatus('æ¥ç¶šå®Œäº†', 'connected');

            } catch (err) {
                console.error(err);
                if (err.name !== 'AbortError') alert('æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + err.message);
            }
        }

        async function reconnectDatabase(handle) {
            try {
                const opts = { mode: 'readwrite' };
                if ((await handle.queryPermission(opts)) !== 'granted') {
                    if ((await handle.requestPermission(opts)) !== 'granted') {
                        alert('è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                        return;
                    }
                }

                fileHandle = handle;
                await loadFromFile();

                if (filePoller) clearInterval(filePoller);
                filePoller = setInterval(checkFileUpdates, 3000);

                document.getElementById('introBarrier').style.display = 'none';
                document.getElementById('mainContent').classList.add('active');
                document.getElementById('btnConnect').textContent = 'æ¥ç¶šæ¸ˆã¿: ' + fileHandle.name;
                document.getElementById('btnConnect').classList.add('success');
                document.getElementById('btnConnect').classList.remove('primary');
                document.getElementById('btnConnect').onclick = connectDatabase;

                updateStatus('æ¥ç¶šå®Œäº†', 'connected');

            } catch (e) {
                console.error(e);
                alert('å†æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                connectDatabase();
            }
        }

        async function checkFileUpdates() {
            if (!fileHandle) return;
            try {
                const file = await fileHandle.getFile();
                if (file.lastModified > lastModifiedTime) {
                    updateStatus('åŒæœŸä¸­...', 'syncing');
                    const text = await file.text();
                    const json = JSON.parse(text);

                    if (json && json.events) {
                        state.events = json.events || [];
                        state.users = json.users || [];
                    } else {
                        // Fallback or init
                        state.events = [];
                        state.users = [];
                    }

                    lastModifiedTime = file.lastModified;
                    renderCalendar();
                    updateStatus('æ¥ç¶šå®Œäº†', 'connected');
                }
            } catch (err) {
                console.warn("Polling error", err);
                updateStatus('å†æ¥ç¶šä¸­...', 'syncing');
            }
        }

        async function loadFromFile() {
            const file = await fileHandle.getFile();
            const text = await file.text();
            lastModifiedTime = file.lastModified;

            try {
                // Load local sort order
                state.userOrder = (await getPref(PREF_USER_ORDER)) || [];
            } catch (e) {
                console.warn('DB Load error', e);
            }

            if (text) {
                try {
                    const json = JSON.parse(text);
                    state.events = json.events || [];
                    state.users = json.users || [];
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    state.events = [];
                    state.users = [];
                }
            } else {
                state.events = [];
                state.users = [];
            }

            // Merge Private Events
            const privateEvents = await getPrivateEvents();
            state.events = [...state.events, ...privateEvents];

            renderCalendar();
        }

        // --- Private Event Logic ---
        async function getPrivateEvents() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_PRIVATE, 'readonly');
                const store = tx.objectStore(STORE_PRIVATE);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject([]);
            });
        }

        async function savePrivateEvent(evt) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_PRIVATE, 'readwrite');
                const store = tx.objectStore(STORE_PRIVATE);
                store.put(evt);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        }

        async function deletePrivateEvent(id) {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_PRIVATE, 'readwrite');
                const store = tx.objectStore(STORE_PRIVATE);
                store.delete(id);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        }

        async function writeToFile(events) {
            if (!fileHandle) return;
            try {
                updateStatus('ä¿å­˜ä¸­...', 'syncing');
                const writable = await fileHandle.createWritable();
                // Save as object { users, events }
                const data = {
                    users: state.users,
                    events: events
                };
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();

                const file = await fileHandle.getFile();
                lastModifiedTime = file.lastModified;

                updateStatus('ä¿å­˜å®Œäº†', 'connected');
            } catch (err) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                updateStatus('ä¿å­˜å¤±æ•—', 'dot');
            }
        }

        async function saveTransaction(actionCallback) {
            if (!fileHandle) return;
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                let currentData = text ? JSON.parse(text) : { users: [], events: [] };

                // Ensure structure
                if (!currentData.users) currentData.users = [];
                if (!currentData.events) currentData.events = [];

                // Update events
                // actionCallback returns the NEW list of events. 
                // We need to differentiate: 
                // 1. The new event list contains mixed (Public + Private).
                // 2. We must split them. Public -> JSON, Private -> IndexedDB.

                // However, actionCallback logic acts on state.events.
                // To keep it simple, we don't pass `currentData.events` (file only) to callback.
                // We pass `state.events` (mixed).

                let allEvents = actionCallback(state.events);

                // Separation
                const publicEvents = allEvents.filter(e => !isPrivate(e));
                const privateEvents = allEvents.filter(e => isPrivate(e));

                // 1. Save Public to JSON
                await writeToFile(publicEvents); // writeToFile wraps in {users, events}

                // 2. Save Private to DB
                // We overwrite DB? Or sync? 
                // Simplest is to save individual private events or sync list.
                // Since we rely on ID, let's sync efficiently. 
                // Make sure we delete ones that are gone? 
                // For simplicity: clear and rewrite private store? Or just Put all.
                // Deleting removed private events is tricky if we just Put.

                // Better approach for Private: 
                // Since we just have a list, let's clear store and add all (inefficient but safe).
                await clearPrivateStore();
                for (const p of privateEvents) {
                    await savePrivateEvent(p);
                }

                state.events = allEvents;
                renderCalendar();
            } catch (err) {
                alert("ç«¶åˆãŒç™ºç”Ÿã—ãŸã‹ã€ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚" + err.message);
            }
        }

        function isPrivate(e) {
            const cat = CATEGORIES.find(c => c.id === (e.categoryId || e.userId));
            return cat && cat.isPrivate;
        }

        async function clearPrivateStore() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_PRIVATE, 'readwrite');
                const store = tx.objectStore(STORE_PRIVATE);
                store.clear();
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject();
            });
        }

        // --- UI Helpers ---

        function updateStatus(text, dotClass) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusDot').className = 'dot ' + dotClass;
        }

        function renderFilters() {
            const container = document.getElementById('filterGroup');
            const btnsHtml = CATEGORIES.map(cat => `
            <div class="filter-btn ${state.activeFilters.has(cat.id) ? 'active' : ''}" 
                 style="background: ${cat.color}" 
                 onclick="toggleFilter('${cat.id}')"
                 title="${cat.name}ã‚’è¡¨ç¤º/éè¡¨ç¤º">
                ${cat.name}
            </div>
        `).join('');
            container.innerHTML = `<span class="filter-label">è¡¨ç¤º:</span>` + btnsHtml;
        }

        function toggleFilter(catId) {
            if (state.activeFilters.has(catId)) {
                state.activeFilters.delete(catId);
            } else {
                state.activeFilters.add(catId);
            }

            setPref('activeFilters', Array.from(state.activeFilters));
            renderFilters();
            renderCalendar();
        }

        function renderModalSelector() {
            const container = document.getElementById('modalCategorySelector');
            container.innerHTML = CATEGORIES.map((cat, idx) => `
            <label class="radio-option">
                <input type="radio" name="category" value="${cat.id}" ${idx === 0 ? 'checked' : ''}>
                <div class="radio-circle" style="border-color: ${cat.color}; background: ${cat.color}20"></div>
                ${cat.name}
            </label>
        `).join('');
        }

        function switchView(mode) {
            state.viewMode = mode;
            renderViewSwitcher();
            renderCalendar(); // Renders appropriate view
        }

        function renderViewSwitcher() {
            document.getElementById('btnViewMonth').className = `view-btn ${state.viewMode === 'month' ? 'active' : ''}`;
            document.getElementById('btnViewDay').className = `view-btn ${state.viewMode === 'day' ? 'active' : ''}`;
        }

        function navigateDate(delta) {
            if (state.viewMode === 'month') {
                state.currentDate.setMonth(state.currentDate.getMonth() + delta);
            } else {
                state.currentDate.setDate(state.currentDate.getDate() + delta);
            }
            renderCalendar();
        }

        function renderCalendar() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const date = state.currentDate.getDate();

            if (state.viewMode === 'month') {
                document.getElementById('calendarGrid').style.display = 'grid';
                document.getElementById('boardView').classList.remove('active');
                document.getElementById('monthLabel').textContent = `${year}å¹´ ${month + 1}æœˆ`;
                renderMonthView();
            } else {
                document.getElementById('calendarGrid').style.display = 'none';
                document.getElementById('boardView').classList.add('active');
                document.getElementById('monthLabel').textContent = `${year}å¹´ ${month + 1}æœˆ ${date}æ—¥`;
                renderBoardView();
            }
        }

        function renderMonthView() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayIndex = firstDay.getDay();
            const totalDays = lastDay.getDate();
            const grid = document.getElementById('calendarGrid');
            const headers = Array.from(grid.children).slice(0, 7);
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDayIndex - 1; i >= 0; i--) {
                grid.innerHTML += createDayHTML(prevMonthLastDay - i, true);
            }
            const today = new Date();
            for (let i = 1; i <= totalDays; i++) {
                const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const dayDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                grid.innerHTML += createDayHTML(i, false, isToday, dayDateStr);
            }
            const remaining = 42 - (startDayIndex + totalDays);
            for (let i = 1; i <= remaining; i++) {
                grid.innerHTML += createDayHTML(i, true);
            }
        }

        function renderBoardView() {
            const container = document.getElementById('boardView');
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const day = state.currentDate.getDate();
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Get events for today, filtered
            const dayEvents = state.events.filter(e => {
                let catId = resolveCategoryId(e);
                return e.date === dateStr && state.activeFilters.has(catId);
            });
            dayEvents.sort((a, b) => {
                const timeDiff = a.time.localeCompare(b.time);
                if (timeDiff !== 0) return timeDiff;
                const catA = CATEGORIES.findIndex(c => c.id === resolveCategoryId(a));
                const catB = CATEGORIES.findIndex(c => c.id === resolveCategoryId(b));
                return catA - catB;
            });

            // Group by User
            // Events can have multiple writers (e.writers) or single (e.writer)
            // If e.writers has ['A', 'B'], show in both A and B rows.
            // If empty, show in Unassigned.

            const userMap = new Map();
            state.users.forEach(u => userMap.set(u, []));
            const unassigned = [];

            dayEvents.forEach(e => {
                let assigned = false;
                const writers = e.writers || (e.writer ? [e.writer] : []);
                if (writers.length > 0) {
                    writers.forEach(w => {
                        if (userMap.has(w)) {
                            userMap.get(w).push(e);
                            assigned = true;
                        }
                    });
                    // If writers exist but not in registry (deleted users), treat as unassigned or legacy? 
                    // Let's assume legacy names just don't appear in rows unless we add 'Others'.
                    // For now, only registered users get rows.
                }
                if (!assigned && writers.length === 0) {
                    unassigned.push(e);
                }
            });

            let html = '';

            // Render User Rows (using sorted order)
            const sortedUsers = getSortedUsers();

            sortedUsers.forEach((u, idx) => {
                const events = userMap.get(u);
                const eventHtml = events.map(e => createEventChip(e, true)).join('');

                html += `
                <div class="board-row">
                    <div class="board-user-label">
                        <div style="flex:1;">${escapeHtml(u)}</div>
                        <div style="display:flex; flex-direction:column; gap:2px;">
                            <button class="btn btn-icon-only" style="padding:0; width:16px; height:16px; font-size:0.5rem; line-height:1;" onclick="moveUser(${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>â–²</button>
                            <button class="btn btn-icon-only" style="padding:0; width:16px; height:16px; font-size:0.5rem; line-height:1;" onclick="moveUser(${idx}, 1)" ${idx === sortedUsers.length - 1 ? 'disabled' : ''}>â–¼</button>
                        </div>
                    </div>
                    <div class="board-timeline" onclick="openAddModal('${dateStr}', ['${escapeHtml(u)}'])">
                        ${eventHtml}
                    </div>
                </div>`;
            });

            // Render Unassigned
            if (unassigned.length > 0) {
                const eventHtml = unassigned.map(e => createEventChip(e, true)).join('');
                html += `
                <div class="board-row">
                    <div class="board-user-label" style="font-style:italic;">æœªå‰²ã‚Šå½“ã¦</div>
                    <div class="board-timeline" onclick="openAddModal('${dateStr}')">
                        ${eventHtml}
                    </div>
                </div>`;
            } else if (state.users.length === 0) {
                html = `<div style="padding:2rem; text-align:center; color:#aaa;">ãƒ¡ãƒ³ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ã€Œãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
            }

            container.innerHTML = html;
        }

        // Refactored Event Chip Creation
        function createEventChip(e, showTime = false) {
            let catId = resolveCategoryId(e);
            const cat = CATEGORIES.find(c => c.id === catId) || CATEGORIES[0];
            let writersStr = '';

            if (e.writers && Array.isArray(e.writers)) writersStr = e.writers.join(', ');

            const writerHtml = (writersStr && !showTime) ? `<span class="event-writer">${escapeHtml(writersStr)}</span>` : '';
            const completedClass = e.completed ? 'completed' : '';

            // Build a more detailed title for the tooltip
            let tooltip = `${e.time} - ${e.title}`;
            if(writersStr) tooltip += `\næ‹…å½“: ${writersStr}`;
            if(e.desc) tooltip += `\nè©³ç´°: ${e.desc}`;

            return `
                <div class="event-chip ${completedClass}" 
                        data-category="${cat.id}"
                        style="background: ${cat.color}"
                        title="${escapeHtml(tooltip)}"
                        onclick="openEditModal('${e.id}', event)">
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${e.time} ${escapeHtml(e.title)}
                        </span>
                        ${writerHtml}
                </div>
            `;
        }

        function createDayHTML(dayNum, isGrey, isToday = false, dateStr = '') {
            let eventsHTML = '';
            let isHoliday = false;
            let holidayName = '';

            // Determine if weekend or holiday
            let dayClass = '';
            let dateObj = null;

            if (!isGrey && dateStr) {
                dateObj = new Date(dateStr);
                const dayOfWeek = dateObj.getDay(); // 0=Sun, 6=Sat

                if (dayOfWeek === 0) dayClass = 'is-sunday';
                else if (dayOfWeek === 6) dayClass = 'is-saturday';

                const dayEvents = state.events.filter(e => {
                    let catId = resolveCategoryId(e);
                    // Manual holiday check removed
                    return e.date === dateStr && state.activeFilters.has(catId);
                });

                // Check for Static Holiday
                if (typeof HOLIDAYS !== 'undefined' && HOLIDAYS[dateStr]) {
                    isHoliday = true;
                    holidayName = HOLIDAYS[dateStr];
                }

                if (isHoliday) dayClass = 'is-holiday';

                dayEvents.sort((a, b) => {
                    const timeDiff = a.time.localeCompare(b.time);
                    if (timeDiff !== 0) return timeDiff;
                    const catA = CATEGORIES.findIndex(c => c.id === resolveCategoryId(a));
                    const catB = CATEGORIES.findIndex(c => c.id === resolveCategoryId(b));
                    return catA - catB;
                });

                dayEvents.forEach(e => {
                    eventsHTML += createEventChip(e);
                });
            }

            return `
            <div class="day-cell ${isGrey ? 'other-month' : ''} ${isToday ? 'today' : ''} ${dayClass}"
                 ${!isGrey ? `onclick="openAddModal('${dateStr}')"` : ''}>
                <div class="day-number">
                    ${dayNum}
                    ${holidayName ? `<span class="holiday-name">${holidayName}</span>` : ''}
                </div>
                <div class="events-stack">${eventsHTML}</div>
            </div>`;
        }

        // Helper to map old IDs to new ones
        function resolveCategoryId(evt) {
            let raw = evt.categoryId || evt.userId;

            // If it's a valid ID, return it
            if (CATEGORIES.some(c => c.id === raw)) return raw;

            // Fallback
            return 'cat_zen';
        }

        // --- Modal Actions ---

        function openAddModal(dateStr, preselectedWriters = []) {
            if (!fileHandle) { alert("ã¾ãšã¯ã€Œãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã—ã¦ãã ã•ã„ã€‚"); return; }

            editingEventId = null;
            document.getElementById('modalTitle').textContent = 'äºˆå®šã‚’è¿½åŠ ';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = dateStr;
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDesc').value = '';
            document.getElementById('eventCompleted').checked = false;

            // Logic for default writers:
            // 1. If preselected (from board view click), use those.
            // 2. Else use Saved Preferences.
            let defaults = [];
            if (preselectedWriters.length > 0) {
                defaults = preselectedWriters;
            } else {
                defaults = state.lastSelectedWriters || [];
            }
            renderWriterCheckboxes(defaults);

            // Logic for default category
            const defCat = state.lastSelectedCategory || 'cat_zen';
            const radio = document.querySelector(`input[name="category"][value="${defCat}"]`);
            if (radio) radio.checked = true;

            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('eventModal').classList.add('open');
            setTimeout(() => document.getElementById('eventTitle').focus(), 100);
        }

        function openEditModal(evtId, e) {
            e.stopPropagation();
            const evt = state.events.find(x => x.id === evtId);
            if (!evt) return;

            editingEventId = evtId;
            document.getElementById('modalTitle').textContent = 'äºˆå®šã‚’ç·¨é›†';
            document.getElementById('eventTitle').value = evt.title;
            document.getElementById('eventDate').value = evt.date;
            document.getElementById('eventTime').value = evt.time;
            document.getElementById('eventDesc').value = evt.desc;
            document.getElementById('eventCompleted').checked = !!evt.completed;

            // Checkboxes
            const currentWriters = evt.writers || (evt.writer ? [evt.writer] : []);
            renderWriterCheckboxes(currentWriters);

            const catId = resolveCategoryId(evt);
            const radio = document.querySelector(`input[name="category"][value="${catId}"]`) || document.querySelector('input[name="category"][value="cat_zen"]');
            if (radio) radio.checked = true;

            document.getElementById('btnDelete').style.display = 'block';
            document.getElementById('eventModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('open');
        }

        // Helper to get users in display order
        function getSortedUsers() {
            let sorted = [...state.userOrder];
            const registered = new Set(state.users);
            const orderedSet = new Set(sorted);

            // Filter invalid (deleted from master)
            sorted = sorted.filter(u => registered.has(u));

            // Append missing (newly added to master)
            state.users.forEach(u => {
                if (!orderedSet.has(u)) sorted.push(u);
            });
            return sorted;
        }

        async function editUser(oldName) {
            const newName = prompt('ä¿®æ­£å¾Œã®æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', oldName);
            if (!newName || newName === oldName) return;

            if (state.users.includes(newName)) {
                alert('ãã®åå‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }

            // Update Users List
            const idx = state.users.indexOf(oldName);
            if (idx !== -1) {
                state.users[idx] = newName;
            }

            // Update Sort Order
            const sortIdx = state.userOrder.indexOf(oldName);
            if (sortIdx !== -1) {
                state.userOrder[sortIdx] = newName;
                await setPref(PREF_USER_ORDER, state.userOrder);
            }

            // Update All Events
            const newEvents = state.events.map(e => {
                let changed = false;
                let newWriters = e.writers;

                // Rename in 'writers' array
                if (e.writers && e.writers.includes(oldName)) {
                    newWriters = e.writers.map(w => w === oldName ? newName : w);
                    changed = true;
                }

                // Rename single 'writer' (legacy support)
                let newWriter = e.writer;
                if (e.writer === oldName) {
                    newWriter = newName;
                    changed = true;
                }

                if (changed) {
                    return { ...e, writers: newWriters, writer: newWriter, updatedAt: Date.now() };
                }
                return e;
            });

            state.events = newEvents;
            renderUserList();
            renderCalendar();

            // Save actions
            if (fileHandle) {
                await saveTransaction((currentEvents) => {
                    return currentEvents.map(e => {
                        let newWriters = e.writers;
                        if (e.writers && e.writers.includes(oldName)) {
                            newWriters = e.writers.map(w => w === oldName ? newName : w);
                        }
                        let newWriter = e.writer;
                        if (e.writer === oldName) {
                            newWriter = newName;
                        }
                        if (JSON.stringify(newWriters) !== JSON.stringify(e.writers) || newWriter !== e.writer) {
                            return { ...e, writers: newWriters, writer: newWriter, updatedAt: Date.now() };
                        }
                        return e;
                    });
                });
            }
        }

        function renderUserList() {
            const container = document.getElementById('userListDisplay');
            if (!container) return; // Guard
            const displayUsers = getSortedUsers();

            container.innerHTML = displayUsers.map((name, idx) => `
                <div class="user-chip">
                    <span style="flex:1;">${escapeHtml(name)}</span>
                    <div style="display:flex; gap:2px; margin-right:8px;">
                        <button class="btn btn-icon-only" style="padding:2px; width:20px; height:20px; font-size:0.6rem;" onclick="moveUser(${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>â–²</button>
                        <button class="btn btn-icon-only" style="padding:2px; width:20px; height:20px; font-size:0.6rem;" onclick="moveUser(${idx}, 1)" ${idx === displayUsers.length - 1 ? 'disabled' : ''}>â–¼</button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-icon-only" style="padding:4px; font-size:0.8rem; height:auto;" onclick='editUser(${JSON.stringify(name)})' title="åå‰ã‚’ä¿®æ­£">âœï¸</button>
                        <span class="delete-btn" onclick='deleteUser(${JSON.stringify(name)})'>&times;</span>
                    </div>
                </div>
             `).join('');
        }

        async function moveUser(idx, direction) {
            const displayUsers = getSortedUsers();
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= displayUsers.length) return;

            // Swap in local array logic
            const temp = displayUsers[idx];
            displayUsers[idx] = displayUsers[newIdx];
            displayUsers[newIdx] = temp;

            state.userOrder = displayUsers;
            await setPref(PREF_USER_ORDER, state.userOrder);

            renderUserList();
            renderCalendar();
        }

        async function saveEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const desc = document.getElementById('eventDesc').value;
            const completed = document.getElementById('eventCompleted').checked;

            // Collect writers
            const checkboxes = document.querySelectorAll('#writerCheckboxes input:checked');
            const writers = Array.from(checkboxes).map(cb => cb.value);

            const categoryId = document.querySelector('input[name="category"]:checked').value;

            if (!title || !date) { alert('å¿…é ˆé …ç›®ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

            // Save Preferences
            setPref(PREF_LAST_CAT, categoryId);
            state.lastSelectedCategory = categoryId;
            setPref(PREF_LAST_WRITERS, writers);
            state.lastSelectedWriters = writers;

            closeModal();

            await saveTransaction((events) => {
                const eventData = {
                    title, date, time, desc, writers, categoryId, completed
                };

                if (editingEventId) {
                    // Update
                    return events.map(e => e.id === editingEventId ? {
                        ...e, ...eventData, updatedAt: Date.now()
                    } : e);
                } else {
                    // Create
                    const newEvent = {
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                        ...eventData,
                        createdAt: Date.now()
                    };
                    return [...events, newEvent];
                }
            });
        }

        // --- User Management Logic ---
        function openUserModal() {
            renderUserList();
            document.getElementById('userModal').classList.add('open');
            setTimeout(() => document.getElementById('newUserName').focus(), 100);
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('open');
        }



        async function moveUser(idx, direction) {
            const newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= state.users.length) return;

            // Swap
            const temp = state.users[idx];
            state.users[idx] = state.users[newIdx];
            state.users[newIdx] = temp;

            renderUserList();

            // Save immediately
            if (fileHandle) {
                try {
                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    let json = text ? JSON.parse(text) : { users: [], events: [] };

                    // Keep events, update users
                    if (json && json.events) {
                        json.users = state.users;
                    } else {
                        // Fallback
                        json = { users: state.users, events: [] };
                    }

                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(json, null, 2));
                    await writable.close();
                } catch (e) {
                    console.error(e);
                    alert('ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }
        }

        async function exportPrivateData() {
            const privateEvents = await getPrivateEvents();
            if (privateEvents.length === 0) {
                alert('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªäºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const blob = new Blob([JSON.stringify(privateEvents, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `private_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function importPrivateData(input) {
            const file = input.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const json = JSON.parse(text);

                if (!Array.isArray(json)) {
                    alert('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚é…åˆ—å½¢å¼ã®JSONã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (!confirm(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆäºˆå®šã«è¿½åŠ ãƒ»ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n(${json.length}ä»¶)`)) {
                    input.value = '';
                    return;
                }

                // Merge import
                await clearPrivateStore(); // Optional: Clear or Append? User asked for migration support implies replace or merge. 
                // Usually restore = replace or smart merge. 
                // Let's go with "Merge/Overwrite by ID".

                // Better strategy: Keep existing, add imported.
                // But if ID collision? Overwrite.

                // Wait, logic above was "clearPrivateStore" then loop. 
                // If I want to KEEP existing, I should read them first? 
                // Implementation Plan said: "Load JSON and overwrite/merge".

                // Let's do simple PUT loop.
                for (const evt of json) {
                    // Ensure it is marked private
                    // (Though if imported from private backup it should be)
                    // Just in case, force category logic compliance? 
                    // No, evt should have categoryId = 'cat_private'

                    if (evt.categoryId === 'cat_private') {
                        await savePrivateEvent(evt);
                    }
                }

                // Reload
                state.events = [...(state.events.filter(e => !isPrivate(e))), ...json.filter(e => isPrivate(e))];
                // Actually we should reload full state properly
                const privateEvents = await getPrivateEvents(); // Real source of truth
                // We need to re-read public events too? 
                // state.events currently has mixed. 
                // Let's allow simple refresh:

                const publicEvents = state.events.filter(e => !isPrivate(e));
                state.events = [...publicEvents, ...privateEvents];

                renderCalendar();
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ã—ã¾ã—ãŸã€‚');

            } catch (e) {
                console.error(e);
                alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            }
            input.value = '';
        }

        async function addUser() {
            const input = document.getElementById('newUserName');
            const name = input.value.trim();
            if (!name) return;

            if (state.users.length >= 99) {
                alert('ç™»éŒ²äººæ•°ãŒä¸Šé™(99äºº)ã«é”ã—ã¦ã„ã¾ã™ã€‚');
                return;
            }
            if (state.users.includes(name)) {
                alert('æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }

            state.users.push(name);
            input.value = '';
            renderUserList();

            // Save immediately
            if (fileHandle) {
                // For user updates, we re-read file to avoid event overwrites, 
                // but simpler to just write full object with current events.
                try {
                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    let json = text ? JSON.parse(text) : { users: [], events: [] };
                    if (Array.isArray(json)) json = { users: [], events: json };

                    json.users = state.users;

                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(json, null, 2));
                    await writable.close();
                } catch (e) {
                    console.error(e);
                    alert('ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }
        }

        async function deleteUser(nameRaw) {
            if (!confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            state.users = state.users.filter(u => u !== nameRaw);
            renderUserList();

            // Save immediately (Master list update)
            if (fileHandle) {
                try {
                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    let json = text ? JSON.parse(text) : { users: [], events: [] };
                    if (Array.isArray(json)) json = { users: [], events: json };

                    json.users = state.users;

                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(json, null, 2));
                    await writable.close();
                } catch (e) {
                    console.error(e);
                }
            }
        }

        function renderWriterCheckboxes(selectedWriters) {
            const container = document.getElementById('writerCheckboxes');
            const displayUsers = getSortedUsers(); // Use sorted order

            if (displayUsers.length === 0) {
                container.innerHTML = '<span style="color:#aaa; font-size:0.8rem;">ãƒ¡ãƒ³ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ã€Œãƒ¡ãƒ³ãƒãƒ¼è¨­å®šã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</span>';
                return;
            }

            container.innerHTML = displayUsers.map(u => {
                const isChecked = selectedWriters.includes(u);
                return `
                <label class="writer-option">
                    <input type="checkbox" value="${escapeHtml(u)}" ${isChecked ? 'checked' : ''}>
                    ${escapeHtml(u)}
                </label>
            `;
            }).join('');
        }

        async function deleteEvent() {
            if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            closeModal();
            await saveTransaction((events) => {
                return events.filter(e => e.id !== editingEventId);
            });
        }

        function changeMonth(delta) {
            state.currentDate.setMonth(state.currentDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            state.currentDate = new Date();
            renderCalendar();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Boot
        init();

    </script>
</body>

</html>